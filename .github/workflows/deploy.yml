name: Deploy SDK

on:
  push:
    branches: [ main, staging ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Build package
      run: |
        echo "üì¶ Building package for debug..."
        python -m pip install --upgrade pip build
        python -m build
        
    - name: Upload package artifacts
      uses: actions/upload-artifact@v4
      with:
        name: package-dist
        path: dist/

  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging'
    environment: staging
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: package-dist
        path: dist/
      
    - name: Debug Step 1 - Environment Info
      run: |
        echo "üîç Step 1: Environment Information"
        echo "Current directory: $(pwd)"
        echo "User: $(whoami)"
        echo "Python version: $(python --version)"
        echo "OS: $(uname -a)"
        echo "Date: $(date)"
        echo "GitHub ref: ${{ github.ref }}"
        echo "GitHub event: ${{ github.event_name }}"
        
    - name: Debug Step 2 - Secret Availability
      env:
        TEST_TOKEN: ${{ secrets.TEST_PYPI_TOKEN }}
      run: |
        echo "üîç Step 2: Secret Debug"
        echo "Checking if TEST_PYPI_TOKEN secret exists..."
        
        if [ -z "$TEST_TOKEN" ]; then
          echo "‚ùå SECRET IS EMPTY OR NOT SET!"
          echo "Secret value is: '${TEST_TOKEN}'"
          echo "Secret length: ${#TEST_TOKEN}"
          exit 1
        else
          echo "‚úÖ Secret exists"
          echo "Secret length: ${#TEST_TOKEN} characters"
        fi
        
    - name: Debug Step 3 - Token Format Check
      env:
        TEST_TOKEN: ${{ secrets.TEST_PYPI_TOKEN }}
      run: |
        echo "üîç Step 3: Token Format Check"
        echo "First 15 characters: ${TEST_TOKEN:0:15}"
        echo "Last 10 characters: ${TEST_TOKEN: -10}"
        
        if [[ "$TEST_TOKEN" == pypi-* ]]; then
          echo "‚úÖ Token starts with 'pypi-'"
        else
          echo "‚ùå Token does NOT start with 'pypi-'"
          echo "Token starts with: ${TEST_TOKEN:0:10}"
        fi
        
        # Check for common issues
        if [[ "$TEST_TOKEN" == *$'\n'* ]]; then
          echo "‚ùå Token contains line breaks!"
        else
          echo "‚úÖ No line breaks in token"
        fi
        
        if [[ "$TEST_TOKEN" == *" "* ]]; then
          echo "‚ùå Token contains spaces!"
        else
          echo "‚úÖ No spaces in token"
        fi
        
    - name: Debug Step 4 - Print Full Token (CAREFUL!)
      env:
        TEST_TOKEN: ${{ secrets.TEST_PYPI_TOKEN }}
      run: |
        echo "üîç Step 4: Full Token Debug (WILL BE VISIBLE IN LOGS!)"
        echo "‚ö†Ô∏è  WARNING: This will expose your token in GitHub logs!"
        echo "Full token: $TEST_TOKEN"
        echo "Token validation complete"
        
    - name: Debug Step 5 - Check Downloaded Package
      run: |
        echo "üîç Step 5: Checking downloaded package files"
        echo "Current directory: $(pwd)"
        echo "Files in current directory:"
        ls -la
        echo "Files in dist directory:"
        ls -la dist/ || echo "No dist directory"
        
        if [ -f dist/*.whl ] 2>/dev/null; then
          echo "‚úÖ Found wheel files"
          ls -la dist/*.whl
        else
          echo "‚ùå No wheel files found"
        fi
        
    - name: Debug Step 6 - Prepare Package Files
      run: |
        echo "üîç Step 6: Preparing package files for upload"
        echo "Available package files:"
        ls -la dist/
        
        # Copy files to current directory for easier access
        cp dist/* . 2>/dev/null || echo "No files to copy"
        
        echo "Files ready for upload:"
        ls -la *.whl *.tar.gz 2>/dev/null || echo "No package files found"
        
    - name: Debug Step 7 - Install Twine
      run: |
        echo "üîç Step 7: Installing twine"
        pip install twine
        echo "Twine version: $(twine --version)"
        
    - name: Debug Step 8 - Test PyPI Connectivity
      run: |
        echo "üîç Step 8: Testing connectivity to Test PyPI"
        curl -I https://test.pypi.org/legacy/ || echo "Connection test failed"
        curl -I https://test.pypi.org/ || echo "Main site connection failed"
        
    - name: Debug Step 9 - Twine Check
      run: |
        echo "üîç Step 9: Checking package with twine"
        twine check *.whl *.tar.gz || echo "Twine check failed"
        
    - name: Debug Step 10 - Upload Test with Full Debug
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_TOKEN }}
      run: |
        echo "üîç Step 10: Upload test with maximum verbosity"
        
        echo "Environment variables:"
        echo "TWINE_USERNAME: $TWINE_USERNAME"
        echo "TWINE_PASSWORD length: ${#TWINE_PASSWORD}"
        echo "TWINE_PASSWORD first 15 chars: ${TWINE_PASSWORD:0:15}"
        
        echo "Files to upload:"
        ls -la dist/
        
        echo "Starting upload with verbose logging..."
        
        # Set all debug flags
        export TWINE_VERBOSE=1
        
        twine upload \
          --repository testpypi \
          --username "$TWINE_USERNAME" \
          --password "$TWINE_PASSWORD" \
          --verbose \
          --skip-existing \
          dist/* || {
          
          echo "‚ùå Upload failed!"
          echo "Exit code: $?"
          
          echo "Let's try some diagnostics:"
          echo "1. Check if token works with curl:"
          
          curl -X POST \
            -H "Authorization: Bearer ${TWINE_PASSWORD/pypi-/}" \
            -H "Content-Type: application/json" \
            https://test.pypi.org/simple/ || echo "Curl test failed"
          
          echo "2. Manual token validation:"
          python3 -c "
import sys
token = '$TWINE_PASSWORD'
print(f'Token length: {len(token)}')
print(f'Starts with pypi-: {token.startswith(\"pypi-\")}')
print(f'Contains spaces: {\" \" in token}')
print(f'Contains newlines: {chr(10) in token}')
          "
          
          exit 1
        }
        
    - name: Debug Step 11 - Success Verification
      run: |
        echo "üîç Step 11: Upload Success!"
        echo "‚úÖ Token is working correctly"
        echo "‚úÖ Package uploaded successfully"
        
        PACKAGE_NAME=$(ls dist/*.whl | head -1 | xargs basename | cut -d'-' -f1)
        echo "üåê Check your package at: https://test.pypi.org/project/$PACKAGE_NAME/"

  deploy-production:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Production Deploy (Placeholder)
      run: |
        echo "üöÄ Production deployment would happen here"
        echo "Skipping for now to focus on staging debug"